# üß™ Gu√≠a de Testing en Desarrollo - Flujo de Autenticaci√≥n y Pago

## üìã Tabla de Contenidos

1. [Setup Inicial](#setup-inicial)
2. [Configuraci√≥n de Variables de Entorno](#configuraci√≥n-de-variables-de-entorno)
3. [Levantar el Servidor](#levantar-el-servidor)
4. [Testing del Flujo OTP (Sin WhatsApp)](#testing-del-flujo-otp-sin-whatsapp)
5. [Testing del Flujo de Pago (Sandbox)](#testing-del-flujo-de-pago-sandbox)
6. [Testing del Flujo Completo](#testing-del-flujo-completo)
7. [Debugging y Troubleshooting](#debugging-y-troubleshooting)

---

## üöÄ Setup Inicial

### 1. Verificar Dependencias

```bash
# Verificar que Node.js est√© instalado
node --version
# Deber√≠a mostrar: v18.x o superior

# Verificar que npm est√© instalado
npm --version
```

### 2. Instalar Dependencias del Proyecto

```bash
# En la ra√≠z del proyecto zecu
npm install
```

---

## üîß Configuraci√≥n de Variables de Entorno

### 1. Crear archivo `.env.local`

En la ra√≠z del proyecto, crea un archivo `.env.local`:

```bash
# Windows PowerShell
New-Item -Path .env.local -ItemType File

# O manualmente: crear archivo .env.local
```

### 2. Configurar Variables M√≠nimas para Testing

Copia esto en tu `.env.local`:

```bash
# ===========================================
# SUPABASE (OBLIGATORIO)
# ===========================================
NEXT_PUBLIC_SUPABASE_URL=https://tu-proyecto.supabase.co
SUPABASE_SERVICE_ROLE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...

# ===========================================
# JWT (OBLIGATORIO)
# ===========================================
# Genera con: node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"
JWT_SECRET=tu-secreto-super-seguro-para-desarrollo

# ===========================================
# MERCADO PAGO (OBLIGATORIO para testing de pagos)
# ===========================================
MERCADOPAGO_ACCESS_TOKEN=TEST-1234567890123456-100000-abcdef123456789
NEXT_PUBLIC_BASE_URL=http://localhost:3000

# ===========================================
# N8N (OPCIONAL - d√©jalo vac√≠o para testing local)
# ===========================================
# Si est√° vac√≠o, los c√≥digos OTP se mostrar√°n en la consola
N8N_WEBHOOK_SEND_OTP_URL=
```

### 3. Obtener Credenciales de Supabase

#### Opci√≥n A: Si ya tienes proyecto en Supabase

1. Ve a [supabase.com/dashboard](https://supabase.com/dashboard)
2. Selecciona tu proyecto
3. Ve a **Settings** ‚Üí **API**
4. Copia:
   - **Project URL** ‚Üí `NEXT_PUBLIC_SUPABASE_URL`
   - **service_role (secret)** ‚Üí `SUPABASE_SERVICE_ROLE_KEY`

#### Opci√≥n B: Crear nuevo proyecto

1. Ve a [supabase.com](https://supabase.com)
2. Click en "New Project"
3. Nombre: `zecu-dev`
4. Database Password: guarda bien esta password
5. Regi√≥n: South America (sao paulo)
6. Espera 2-3 minutos mientras se crea
7. Ve a **Settings** ‚Üí **API** y copia las credenciales

### 4. Ejecutar Migraciones de Base de Datos

```bash
# Opci√≥n 1: Usar Supabase CLI (recomendado)
# Si no tienes Supabase CLI:
npm install -g supabase

# Iniciar sesi√≥n
supabase login

# Link al proyecto
supabase link --project-ref tu-proyecto-ref

# Aplicar migraciones
supabase db push
```

**Opci√≥n 2: Manual (m√°s f√°cil para testing r√°pido)**

1. Ve a tu proyecto en Supabase Dashboard
2. Click en **SQL Editor** (√≠cono de database en el men√∫ izquierdo)
3. Copia y ejecuta estos scripts uno por uno:

**Script 1: Crear tabla `users`**

```sql
-- supabase/migrations/001_create_users_table.sql
CREATE TABLE IF NOT EXISTS public.users (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  phone VARCHAR(20) UNIQUE NOT NULL,
  name VARCHAR(255),
  email VARCHAR(255),
  plan VARCHAR(20) DEFAULT 'free' CHECK (plan IN ('free', 'plus')),
  plan_expires_at TIMESTAMP,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

-- Index para b√∫squedas r√°pidas por tel√©fono
CREATE INDEX IF NOT EXISTS idx_users_phone ON public.users(phone);

-- Index para verificar planes activos
CREATE INDEX IF NOT EXISTS idx_users_plan_expires ON public.users(plan, plan_expires_at);
```

**Script 2: Crear tabla `otp_codes`**

```sql
-- supabase/migrations/002_create_otp_codes_table.sql
CREATE TABLE IF NOT EXISTS public.otp_codes (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  phone VARCHAR(20) NOT NULL,
  code VARCHAR(6) NOT NULL,
  expires_at TIMESTAMP NOT NULL,
  verified BOOLEAN DEFAULT FALSE,
  attempts INTEGER DEFAULT 0,
  created_at TIMESTAMP DEFAULT NOW()
);

-- Index para b√∫squedas r√°pidas
CREATE INDEX IF NOT EXISTS idx_otp_phone_code ON public.otp_codes(phone, code);
CREATE INDEX IF NOT EXISTS idx_otp_expires ON public.otp_codes(expires_at);
```

4. Click **Run** en cada script
5. Verifica que las tablas se crearon: ve a **Table Editor** y deber√≠as ver `users` y `otp_codes`

### 5. Generar JWT Secret

```bash
# En PowerShell o terminal
node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"

# Output ejemplo:
# 5f3a2b1c4d5e6f7a8b9c0d1e2f3a4b5c6d7e8f9a0b1c2d3e4f5a6b7c8d9e0f1a
# Copia esto a JWT_SECRET en .env.local
```

### 6. Obtener Credenciales de Mercado Pago (para testing de pagos)

1. Ve a [Mercado Pago Developers](https://www.mercadopago.com.ar/developers/panel)
2. Crea cuenta si no tienes
3. Ve a **Tus integraciones** ‚Üí **Crear aplicaci√≥n**
4. Nombre: "Zecu Dev"
5. Ve a **Credenciales de prueba (Test)**
6. Copia **Access Token** ‚Üí `MERCADOPAGO_ACCESS_TOKEN`
   - Deber√≠a empezar con `TEST-`

---

## üèÉ Levantar el Servidor

### 1. Iniciar el servidor de desarrollo

```bash
npm run dev
```

Deber√≠as ver:

```
‚ñ≤ Next.js 14.x
- Local:        http://localhost:3000
- Ready in 2.5s
```

### 2. Verificar que el servidor est√© corriendo

Abre tu navegador en: [http://localhost:3000](http://localhost:3000)

Deber√≠as ver el landing page de Zecu.

---

## üß™ Testing del Flujo OTP (Sin WhatsApp)

### Escenario 1: Registro de Usuario Nuevo

#### 1. Ir a la p√°gina de login

```
http://localhost:3000/login
```

#### 2. Ingresar un tel√©fono de prueba

**Formato:** `+54911XXXXXXXX` (Argentina)

Ejemplo: `+5491112345678`

#### 3. Ver el c√≥digo OTP en la consola del servidor

En la terminal donde corre `npm run dev`, deber√≠as ver:

```bash
‚ö†Ô∏è N8N_WEBHOOK_SEND_OTP_URL no configurada, saltando env√≠o de WhatsApp
üì± [DESARROLLO] C√≥digo OTP para +5491112345678: 123456
‚úÖ OTP enviado exitosamente a +5491112345678
```

**¬°Ese es tu c√≥digo!** C√≥pialo (ej: `123456`)

#### 4. Ingresar el c√≥digo en el frontend

1. Pega el c√≥digo en el input (ej: `123456`)
2. Click en "Verificar"
3. Si es usuario nuevo, te pedir√° tu nombre
4. Ingresa un nombre (ej: "Juan Testing")
5. Click "Continuar"

#### 5. Verificar que el usuario se cre√≥

Ve a Supabase Dashboard ‚Üí **Table Editor** ‚Üí **users**

Deber√≠as ver:
- `phone`: `+5491112345678`
- `name`: `Juan Testing`
- `plan`: `free`
- `created_at`: timestamp actual

#### 6. Verificar la sesi√≥n

En el navegador:
1. Abre las **DevTools** (F12)
2. Ve a **Application** ‚Üí **Cookies** ‚Üí `http://localhost:3000`
3. Deber√≠as ver una cookie `session_token`

---

## üí≥ Testing del Flujo de Pago (Sandbox)

### Escenario 2: Usuario Autenticado Compra Plan Plus

#### 1. Ya debes estar autenticado

Si completaste el Escenario 1, ya tienes sesi√≥n activa.

Si no, haz login primero:
```
http://localhost:3000/login
‚Üí Ingresa tel√©fono
‚Üí Copia c√≥digo de la consola
‚Üí Verifica
```

#### 2. Ir al landing page

```
http://localhost:3000
```

Scroll hasta la secci√≥n de precios.

#### 3. Click en "Comenzar con Mercado Pago" (Plan Plus)

**Qu√© deber√≠a pasar:**

1. Se abre una p√°gina de "Procesando tu compra..." (`/checkout`)
2. Muestra el plan seleccionado: **Plus - AR$5.499**
3. Loading de 1-2 segundos
4. Redirige autom√°ticamente a Mercado Pago

#### 4. En Mercado Pago (Sandbox)

Deber√≠as ver el checkout de Mercado Pago con:

```
Plan Plus - Zecu
AR$ 5.499,00

[Pagar con tarjeta de cr√©dito]
[Pagar con tarjeta de d√©bito]
[Otros medios de pago]
```

#### 5. Usar tarjetas de prueba de Mercado Pago

**Tarjeta APROBADA:**
```
N√∫mero: 5031 7557 3453 0604
CVV: 123
Fecha: 11/25
Titular: APRO
DNI: 12345678
```

**Otras tarjetas de prueba:**
- **RECHAZADA:** `5031 4332 1540 6351` + OTHE
- **PENDIENTE:** `5031 4332 1540 6351` + CALL

**Documentaci√≥n completa:** [Mercado Pago Test Cards](https://www.mercadopago.com.ar/developers/es/docs/checkout-api/integration-test/test-cards)

#### 6. Completar el pago

1. Ingresa datos de la tarjeta APROBADA
2. Click "Pagar"
3. Espera confirmaci√≥n
4. Ser√°s redirigido a `/payment/success`

#### 7. Verificar que el webhook se ejecut√≥

En la **consola del servidor** (`npm run dev`), deber√≠as ver:

```bash
Webhook received: { type: 'payment', data: { id: 123456789 } }
Payment info: { id: 123456789, status: 'approved', ... }
‚úÖ Pago aprobado: 123456789
üì¶ Metadata recibida: { user_id: 'uuid', user_phone: '+5491112345678', plan_id: 'plus' }
‚úÖ Plan Plus activado para usuario uuid (+5491112345678)
```

#### 8. Verificar en la base de datos

Ve a Supabase Dashboard ‚Üí **Table Editor** ‚Üí **users**

Busca tu usuario (`+5491112345678`):
- `plan`: deber√≠a ser `plus` (cambi√≥ de `free`)
- `plan_expires_at`: deber√≠a tener una fecha 30 d√≠as en el futuro

---

## üîÑ Testing del Flujo Completo

### Escenario 3: Usuario NO Autenticado Intenta Comprar

#### 1. Cerrar sesi√≥n

En el navegador:
1. Abre **DevTools** (F12)
2. Ve a **Application** ‚Üí **Cookies**
3. Elimina la cookie `session_token`
4. Recarga la p√°gina

#### 2. Click en "Comenzar con Mercado Pago"

**Qu√© deber√≠a pasar:**

1. Aparece un `confirm()` diciendo:
   ```
   Para suscribirte al plan Plus, primero necesitas crear una cuenta o iniciar sesi√≥n.
   ¬°Es r√°pido y solo toma 1 minuto! üöÄ
   
   ¬øQuieres continuar?
   ```
2. Click "Aceptar"
3. Redirige a `/login`

#### 3. Hacer login con un tel√©fono NUEVO

Usa un tel√©fono diferente: `+5491187654321`

1. Ingresa tel√©fono
2. Copia c√≥digo de la consola
3. Verifica
4. Ingresa nombre
5. Click "Continuar"

#### 4. Redirecci√≥n autom√°tica a checkout

**Qu√© deber√≠a pasar:**

1. Despu√©s del login exitoso, detecta la `pendingPurchase` en `sessionStorage`
2. Redirige autom√°ticamente a `/checkout`
3. Procesa la compra
4. Redirige a Mercado Pago

#### 5. Completar el pago

Usa la tarjeta de prueba APROBADA y completa el pago.

#### 6. Verificar que el plan se activ√≥

Ve a Supabase y verifica que el usuario `+5491187654321` tiene `plan: 'plus'`.

---

## üêõ Debugging y Troubleshooting

### Problema 1: "No est√°s autenticado"

**S√≠ntoma:** Al hacer click en el bot√≥n de pago, aparece error de autenticaci√≥n.

**Soluci√≥n:**
1. Verifica que la cookie `session_token` exista
2. Verifica que `JWT_SECRET` est√© configurado en `.env.local`
3. Haz login nuevamente

### Problema 2: "Error al crear la preferencia de pago"

**S√≠ntoma:** Error al intentar crear el pago.

**Posibles causas:**
- `MERCADOPAGO_ACCESS_TOKEN` inv√°lido o expirado
- `NEXT_PUBLIC_BASE_URL` no configurado

**Soluci√≥n:**
1. Verifica las credenciales en `.env.local`
2. Recarga el servidor: `Ctrl+C` ‚Üí `npm run dev`
3. Verifica en la consola del servidor si hay errores de Mercado Pago

### Problema 3: No aparece el c√≥digo OTP en la consola

**S√≠ntoma:** No se muestra el c√≥digo en la terminal.

**Soluci√≥n:**
1. Verifica que `N8N_WEBHOOK_SEND_OTP_URL` est√© vac√≠o o comentado
2. Busca en la consola: `üì± [DESARROLLO]`
3. Scroll hacia arriba en la terminal

### Problema 4: Usuario no encontrado en la base de datos

**S√≠ntoma:** Despu√©s del OTP, no se crea el usuario.

**Soluci√≥n:**
1. Verifica que las tablas `users` y `otp_codes` existan en Supabase
2. Verifica que `SUPABASE_SERVICE_ROLE_KEY` sea correcta
3. Ve a Supabase ‚Üí **SQL Editor** y ejecuta:
   ```sql
   SELECT * FROM users WHERE phone = '+5491112345678';
   ```

### Problema 5: Webhook no se ejecuta despu√©s del pago

**S√≠ntoma:** El pago se completa pero el plan no se activa.

**Causa:** En desarrollo local, Mercado Pago **NO PUEDE** enviar webhooks a `localhost`.

**Soluciones:**

#### Opci√≥n A: Simular webhook manualmente (testing r√°pido)

1. Ve a la consola del servidor despu√©s del pago
2. No ver√°s el log del webhook porque MP no puede alcanzar localhost
3. **Simula el webhook manualmente:**

```bash
# En otra terminal, ejecuta:
curl http://localhost:3000/api/webhooks/mercadopago \
  -X POST \
  -H "Content-Type: application/json" \
  -d '{
    "type": "payment",
    "data": {
      "id": 123456789
    }
  }'
```

**Nota:** Necesitas el ID real del pago que hiciste. Lo puedes obtener de:
- La URL de √©xito: `/payment/success?payment_id=123456789`
- El dashboard de Mercado Pago

#### Opci√≥n B: Usar ngrok (testing completo)

```bash
# 1. Instalar ngrok
# Ve a https://ngrok.com y descarga

# 2. Autenticar (necesitas cuenta gratis)
ngrok authtoken tu-auth-token

# 3. Exponer localhost:3000
ngrok http 3000

# Output:
# Forwarding: https://abc123.ngrok.io -> http://localhost:3000
```

Luego actualiza `.env.local`:

```bash
NEXT_PUBLIC_BASE_URL=https://abc123.ngrok.io
```

Reinicia el servidor y ahora Mercado Pago S√ç podr√° enviar webhooks.

#### Opci√≥n C: Activar plan manualmente (testing de base de datos)

```sql
-- En Supabase SQL Editor
UPDATE users 
SET 
  plan = 'plus',
  plan_expires_at = NOW() + INTERVAL '30 days'
WHERE phone = '+5491112345678';
```

---

## üìä Checklist de Testing Completo

### Testing B√°sico

- [ ] ‚úÖ Servidor levanta sin errores
- [ ] ‚úÖ Landing page carga correctamente
- [ ] ‚úÖ Bot√≥n "Suscribirse a Plus" existe
- [ ] ‚úÖ P√°gina `/login` carga
- [ ] ‚úÖ P√°gina `/checkout` existe

### Testing de OTP

- [ ] ‚úÖ Enviar OTP muestra c√≥digo en consola
- [ ] ‚úÖ C√≥digo OTP se guarda en tabla `otp_codes`
- [ ] ‚úÖ Verificar OTP v√°lido crea usuario
- [ ] ‚úÖ Verificar OTP inv√°lido muestra error
- [ ] ‚úÖ Usuario nuevo se crea con `plan: 'free'`
- [ ] ‚úÖ Cookie `session_token` se establece

### Testing de Autenticaci√≥n

- [ ] ‚úÖ Usuario autenticado ve bot√≥n de pago
- [ ] ‚úÖ Usuario NO autenticado ve confirm
- [ ] ‚úÖ Despu√©s de login, redirect autom√°tico a checkout
- [ ] ‚úÖ Sesi√≥n persiste despu√©s de recargar p√°gina

### Testing de Pago

- [ ] ‚úÖ Crear preferencia de pago funciona
- [ ] ‚úÖ Redirect a Mercado Pago funciona
- [ ] ‚úÖ Tarjeta de prueba APROBADA completa pago
- [ ] ‚úÖ Redirect a `/payment/success` despu√©s del pago
- [ ] ‚úÖ Plan se actualiza de `free` a `plus`
- [ ] ‚úÖ `plan_expires_at` se establece a +30 d√≠as

### Testing de Seguridad

- [ ] ‚úÖ Usuario sin sesi√≥n no puede crear pago
- [ ] ‚úÖ Usuario con plan Plus activo no puede comprar de nuevo
- [ ] ‚úÖ `pendingPurchase` expira despu√©s de 30 min

---

## üéØ Flujo T√≠pico de Testing (5 minutos)

```bash
1. npm run dev
2. Ir a http://localhost:3000
3. Click "Suscribirse a Plus" (sin login)
4. Confirmar ‚Üí Redirige a /login
5. Ingresar +5491112345678
6. Copiar c√≥digo de consola (ej: 123456)
7. Verificar c√≥digo
8. Ingresar nombre "Test User"
9. Auto-redirect a /checkout
10. Auto-redirect a Mercado Pago
11. Usar tarjeta: 5031 7557 3453 0604 / 123 / 11/25 / APRO
12. Pagar ‚Üí Success
13. Simular webhook:
    curl -X POST http://localhost:3000/api/webhooks/mercadopago \
      -H "Content-Type: application/json" \
      -d '{"type":"payment","data":{"id":PAYMENT_ID}}'
14. Verificar en Supabase: plan = 'plus' ‚úÖ
```

---

## üìù Logs Importantes

### Frontend (Browser Console)

```javascript
// Verificar sesi√≥n
fetch('/api/auth/check-session')
  .then(r => r.json())
  .then(console.log)
// { authenticated: true, userId: '...', phone: '+54...' }

// Verificar pendingPurchase
console.log(JSON.parse(sessionStorage.getItem('pendingPurchase')))
// { planId: 'plus', planName: 'Plus', price: 'AR$5.499', timestamp: 1234567890 }
```

### Backend (Server Console)

```bash
# Login exitoso
‚úÖ Nuevo usuario creado: +5491112345678
‚úÖ Usuario existente verificado: +5491112345678

# Pago creado
‚úÖ Preferencia de pago creada para usuario +5491112345678 (uuid)
üí≥ Preferencia creada: pref_123abc para usuario uuid

# Webhook recibido
üì¶ Metadata recibida: { user_id: 'uuid', user_phone: '+54...', plan_id: 'plus' }
‚úÖ Plan Plus activado para usuario uuid (+5491112345678)
```

---

## üöÄ Siguiente Paso: Testing con WhatsApp Real

Para testing con WhatsApp real, necesitas configurar n8n + Twilio.

Ver: `docs/N8N_SETUP.md` (crear este archivo si quieres)

---

**¬øPreguntas?** Cualquier error que encuentres, c√≥pialo completo y te ayudo a debuggearlo.


